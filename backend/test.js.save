import mongoose from "mongoose";
import dotenv from "dotenv";
dotenv.config();

//import models
import User from "./src/models/User.js";
import Tutor from "./src/models/Tutor.js";
import Tutee from "./src/models/Tutee.js";
import Session from "./src/models/Session.js";
import Feedback from "./src/models/Feedback.js";
import Report from "./src/models/Report.js";
import Warning from "./src/models/Warning.js";
import Notification from "./src/models/Notification.js";
import SubjectCatalog from "./src/models/SubjectCatalog.js";

const MONGO_URI = process.env.MONGO_URI || "mongodb+srv://gsortiz:helloworld1@cluster0.0iryok8.mongodb.net/?appName=Cluster0";

const runTests = async () => {
  try {
    console.log("üîå Connecting to MongoDB...");
    await mongoose.connect(MONGO_URI);
    console.log("‚úÖ Connected to MongoDB\n");

    // Clean test database (optional)
    await mongoose.connection.db.dropDatabase();
    console.log("üßπ Cleared test database\n");

    // 1Ô∏è‚É£ User
0    const user = await User.create({
      name: "John Doe",
      email: "john@up.edu.ph",
      role: "tutor",
      degree_program: "BS Computer Science",
    });
    console.log("‚úÖ User created:", user._id);

    // 2Ô∏è‚É£ Tutor (linked to user)
    const tutor = await Tutor.create({
      userId: user._id,
      subjectsOffered: ["CMSC 11", "MATH 17"],
      bio: "Passionate about teaching programming.",
      certified: true,
    });
    console.log("‚úÖ Tutor created:", tutor._id);

    // 3Ô∏è‚É£ Tutee (also linked to user)
    const tutee = await Tutee.create({
      userId: user._id,
      preferredSubjects: ["MATH 17"],
    });
    console.log("‚úÖ Tutee created:", tutee._id);

    // 4Ô∏è‚É£ Subject Catalog
    const subject = await SubjectCatalog.create({
      code: "CMSC 11",
      name: "Introduction to Computer Science",
      classification: "Core",
      active: true,
    });
    console.log("‚úÖ Subject created:", subject.code);

    // 5Ô∏è‚É£ Session
    const session = await Session.create({
      tutorId: user._id,
      createdByTuteeId: user._id,
      topic: "Basic Programming",
      location: "DLRC",
      startTime: new Date(),
      endTime: new Date(Date.now() + 60 * 60 * 1000),
      status: "approved",
      participants: [{ userId: user._id, attendance_status: "present" }],
    });
    console.log("‚úÖ Session created:", session._id);

    // 6Ô∏è‚É£ Feedback
    const feedback = await Feedback.create({
      sessionId: session._id,
      tutorId: user._id,
      tuteeId: user._id,
      rating: 5,
      comment: "Very helpful tutor!",
    });
    console.log("‚úÖ Feedback created:", feedback._id);

    // 7Ô∏è‚É£ Report
    const report = await Report.create({
      reporterId: user._id,
      reportedId: user._id,
      sessionId: session._id,
      description: "Inappropriate behavior during session",
    });
    console.log("‚úÖ Report created:", report._id);

    // 8Ô∏è‚É£ Warning
    const warning = await Warning.create({
      userId: user._id,
      reportId: report._id,
      reason: "Violation of LRC policy",
    });
    console.log("‚úÖ Warning created:", warning._id);

    // 9Ô∏è‚É£ Notification
    const notification = await Notification.create({
      recipientId: user._id,
      type: "session_approved",
      payload: { sessionId: session._id },
      isRead: false,
    });
    console.log("‚úÖ Notification created:", notification._id);

    // üîç Populate and verify relationships
    const populatedSession = await Session.findById(session._id)
      .populate("tutorId")
      .populate("createdByTuteeId");
    console.log("\nüîé Populated Session:");
    console.log(populatedSession);

    console.log("\nüéâ All models tested successfully!");

  } catch (err) {
    console.error("‚ùå Error during testing:", err);
  } finally {
    await mongoose.disconnect();
    console.log("\nüîå Disconnected from MongoDB");
  }
};

runTests();


